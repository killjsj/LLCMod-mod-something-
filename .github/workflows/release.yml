name: Sync and Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: '无版本号'
  schedule:
    - cron: '0 0 * * *'  # 每天 UTC 时间 00:00 触发

jobs:
  release:
    runs-on: windows-latest

    steps:
      # 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 缓存 NuGet 包
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('src/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # 添加上游仓库并同步更新
      - name: Fetch upstream changes
        run: |
          git remote add upstream https://github.com/LocalizeLimbusCompany/LocalizeLimbusCompany.git
          git fetch upstream

      - name: Merge upstream changes
        run: |
          git checkout main
          git merge upstream/main

      # 设置 Python 环境
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # 运行 Python 脚本修改文件
      - name: Run Python script to modify files
        run: |
          python ISLMAEL.py

      # 不提取版本号

      # 运行编译脚本
      - name: Run build script
        run: |
          ./build.ps1 ${{ steps.extract_version.outputs.release_tag }}

      # 更新 CHANGELOG.md
      - name: Update CHANGELOG.md
        run: |
          Add-Content -Path CHANGELOG.md -Value "
          # 下载
          - LimbusLocalize_BIE_${{ steps.extract_version.outputs.release_tag }}.7z 全量包"

      # 创建 GitHub Release
      - name: Create Upload Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            Release/*.7z
          body_path: CHANGELOG.md
          tag_name: ${{ steps.extract_version.outputs.release_tag }}
